# yaml-language-server: $schema=./node_modules/envio/evm.schema.json
name: recall-live-trading-indexer
description: Shared live trading indexer for all competitions

# Global contract definition for multichain indexing
contracts:
  # Track all ERC20 transfers for self-funding and exit detection
  - name: ERC20Transfers
    handler: src/EventHandlers.ts
    events:
    - event: "Transfer(address indexed from, address indexed to, uint256 value)"
  
  # Uniswap V2 and forks (SushiSwap, PancakeSwap, QuickSwap, Velodrome, Aerodrome, etc.)
  # This signature covers ~40% of all DEX volume including Optimism/Base native DEXes
  - name: UniswapV2
    handler: src/EventHandlers.ts
    events:
    - event: "Swap(address indexed sender, uint256 amount0In, uint256 amount1In, uint256 amount0Out, uint256 amount1Out, address indexed to)"
    
  # Uniswap V3 - Second largest DEX by volume
  # Note: amount0 and amount1 are int256 (can be negative)
  - name: UniswapV3
    handler: src/EventHandlers.ts
    events:
    - event: "Swap(address indexed sender, address indexed recipient, int256 amount0, int256 amount1, uint160 sqrtPriceX96, uint128 liquidity, int24 tick)"
    
  # Curve Finance - Popular for stablecoin swaps
  # Uses token indices instead of addresses
  - name: Curve
    handler: src/EventHandlers.ts
    events:
    - event: "TokenExchange(address indexed buyer, int128 sold_id, uint256 tokens_sold, int128 bought_id, uint256 tokens_bought)"
    
  # Balancer V1 - Multi-asset pools
  - name: BalancerV1
    handler: src/EventHandlers.ts
    events:
    - event: "LOG_SWAP(address indexed caller, address indexed tokenIn, address indexed tokenOut, uint256 tokenAmountIn, uint256 tokenAmountOut)"
    
  # NOTE: 1inch AggregationRouter V4/V5 does NOT emit swap events
  # As an aggregator, it routes through other DEXes which emit their own events
  # 1inch trades are captured via the underlying DEX events (Uniswap, Curve, etc.)
    
  # 0x Protocol V3/V4 - Another major aggregator
  # Note: This is a simplified version, full event has more parameters
  - name: ZeroEx
    handler: src/EventHandlers.ts
    events:
    - event: "Fill(address indexed makerAddress, address indexed feeRecipientAddress, address takerAddress, address senderAddress, uint256 makerAssetFilledAmount, uint256 takerAssetFilledAmount, uint256 makerFeePaid, uint256 takerFeePaid, bytes32 indexed orderHash)"
    
  # Balancer V2 - All swaps go through the Vault contract
  # Different from V1, uses poolId instead of separate pool contracts
  - name: BalancerV2
    handler: src/EventHandlers.ts
    events:
    - event: "Swap(bytes32 indexed poolId, address indexed tokenIn, address indexed tokenOut, uint256 amountIn, uint256 amountOut)"
    
  # Bancor V3 - Uses BNT as intermediary token
  # Note: bntAmount and bntFee track the BNT token involvement
  - name: Bancor
    handler: src/EventHandlers.ts
    events:
    - event: "TokensTraded(address indexed trader, address sourceToken, address targetToken, uint256 sourceAmount, uint256 targetAmount, uint256 bntAmount, uint256 bntFee)"
    
    # NOT INCLUDED but notable (need exact signatures):
    # - CoW Swap: Uses batch auctions with Trade events
    # - Kyber DMM: Dynamic fees
    # Together these represent <1% of volume

networks:
  - id: 1 # Ethereum
    start_block: 23247973 # Current block as of Aug 2025
    contracts:
      - name: ERC20Transfers
      - name: UniswapV2
      - name: UniswapV3
      - name: Curve
      - name: BalancerV1
      - name: BalancerV2
      - name: ZeroEx
      - name: Bancor

  - id: 137 # Polygon
    start_block: 75806701 # Current block as of Aug 2025
    contracts:
      - name: ERC20Transfers
      - name: UniswapV2
      - name: UniswapV3
      - name: Curve
      - name: BalancerV1
      - name: BalancerV2
      - name: ZeroEx

  - id: 42161 # Arbitrum
    start_block: 373586330 # Current block as of Aug 2025
    contracts:
      - name: ERC20Transfers
      - name: UniswapV2
      - name: UniswapV3
      - name: Curve
      - name: BalancerV1
      - name: BalancerV2
      - name: ZeroEx

  - id: 10 # Optimism
    start_block: 140443472 # Current block as of Aug 2025
    contracts:
      - name: ERC20Transfers
      - name: UniswapV2
      - name: UniswapV3
      - name: Curve
      - name: BalancerV1
      - name: BalancerV2
      - name: ZeroEx

  - id: 8453 # Base
    start_block: 34847769 # Current block as of Aug 2025
    contracts:
      - name: ERC20Transfers
      - name: UniswapV2
      - name: UniswapV3
      - name: Curve
      - name: BalancerV1
      - name: BalancerV2
      - name: ZeroEx

# Unordered multichain mode allows you to index events from multiple chains
# in realtime but doesn't guarentee ordering between chains
# https://docs.envio.dev/docs/HyperIndex/multichain-indexing#unordered-multichain-mode
unordered_multichain_mode: true
# Preload optimisation makes your indexer much faster.
# But be aware that your handlers will run twice,
# so make sure to use Effect API for external calls.
preload_handlers: true

# Field selection for transaction data we need
field_selection:
  transaction_fields:
    - hash
    - gasUsed
    - gasPrice
    - from
    - to
