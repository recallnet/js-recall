name: API-SDK Check
description: Checks if API-SDK generated by speakeasy is up to date

runs:
  using: "composite"
  steps:
    - name: Install speakeasy CLI
      shell: bash
      run: |
        set -ex
        d=/tmp/sp.tmp
        mkdir -p $d
        f=$d/se.zip
        curl -Lo $f https://github.com/speakeasy-api/speakeasy/releases/download/v1.551.0/speakeasy_linux_amd64.zip
        cd $d
        unzip $f
        mv speakeasy /usr/local/bin/
        rm -r $d

    - name: Generate API SDK
      shell: bash
      run: |
        set -ex
        (cd apps/api && npm run generate-openapi)
        (cd packages/api-sdk && speakeasy run --skip-versioning)
        pnpm format

    # TODO: figure out correct flow to not make this problematic
    # - name: Check if API SDK is up to date
    #   shell: bash
    #   run: |
    #     ! git status -s | grep -v .speakeasy | grep -v src/hooks/hooks.ts
    - name: Warn if API SDK is out of date
      shell: bash
      run: |
        set +e
        if git status -s | grep -v .speakeasy | grep -v src/hooks/hooks.ts > /tmp/sdk-diff; then
          echo "::warning file=packages/api-sdk::Generated SDK is out of date. Please run \`sh build-api-sdk.sh\` from root."
          echo "--- Diff output ---"
          cat /tmp/sdk-diff
        else
          echo "âœ… SDK is up to date"
        fi
        set -e
